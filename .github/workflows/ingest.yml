name: OB1 Scout - Auto Ingest & Notify

on:
  schedule:
    # Ogni 6 ore: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  ingest-and-notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install requests python-dotenv

    - name: Download previous data (if exists)
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: ob1-database
        path: data/

    - name: Run ingest pipeline
      id: ingest
      env:
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        cd src
        python -c "
import json
import sys
from datetime import datetime
from pathlib import Path

# Run scraper
from scraper import OB1Scraper
scraper = OB1Scraper()
opportunities = scraper.scrape_all()

# Save results
output_dir = Path('../data')
output_dir.mkdir(exist_ok=True)

# Save opportunities
output_file = output_dir / 'opportunities.json'
existing = []
if output_file.exists():
    try:
        existing = json.loads(output_file.read_text())
    except:
        pass

# Merge and deduplicate
all_opps = existing + [o.model_dump() for o in opportunities]
seen = set()
unique = []
for o in all_opps:
    key = (o.get('player_name', ''), o.get('source_url', ''))
    if key not in seen:
        seen.add(key)
        unique.append(o)

# Keep only last 100
unique = sorted(unique, key=lambda x: x.get('discovered_at', ''), reverse=True)[:100]
output_file.write_text(json.dumps(unique, indent=2, ensure_ascii=False, default=str))

# Stats for notification
new_count = len(opportunities)
total_count = len(unique)

print(f'new_opportunities={new_count}')
print(f'total_opportunities={total_count}')

# Save stats
stats = {
    'last_run': datetime.now().isoformat(),
    'new_opportunities': new_count,
    'total_opportunities': total_count,
    'by_type': {}
}
for o in opportunities:
    t = o.opportunity_type.value if hasattr(o, 'opportunity_type') else 'altro'
    stats['by_type'][t] = stats['by_type'].get(t, 0) + 1

(output_dir / 'stats.json').write_text(json.dumps(stats, indent=2))

# Output for GitHub Actions
with open('../.github_output', 'w') as f:
    f.write(f'new_count={new_count}\n')
    f.write(f'total_count={total_count}\n')
"

        # Read outputs
        if [ -f .github_output ]; then
          cat .github_output >> $GITHUB_OUTPUT
        fi

    - name: Send Telegram notification
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}
      run: |
        cd src
        python -c "
import os
import json
from pathlib import Path
from notifier import TelegramNotifier

# Load opportunities
data_file = Path('../data/opportunities.json')
if not data_file.exists():
    print('No data file found')
    exit(0)

opportunities = json.loads(data_file.read_text())

# Get recent (last 6 hours)
from datetime import datetime, timedelta
cutoff = (datetime.now() - timedelta(hours=6)).isoformat()
recent = [o for o in opportunities if o.get('discovered_at', '') > cutoff]

if not recent:
    print('No new opportunities to notify')
    exit(0)

# Send notification
notifier = TelegramNotifier()
dashboard_url = os.getenv('GITHUB_PAGES_URL', '')

if notifier.enabled:
    success = notifier.notify_new_opportunities(recent, dashboard_url)
    print(f'Notification sent: {success}')
else:
    print('Notifier not configured, skipping')
"

    - name: Upload database artifact
      uses: actions/upload-artifact@v4
      with:
        name: ob1-database
        path: data/
        retention-days: 30

    - name: Generate dashboard HTML
      run: |
        cd src
        python -c "
import json
from pathlib import Path
from datetime import datetime

# Load data
data_dir = Path('../data')
opps_file = data_dir / 'opportunities.json'
stats_file = data_dir / 'stats.json'

opportunities = []
stats = {}

if opps_file.exists():
    opportunities = json.loads(opps_file.read_text())
if stats_file.exists():
    stats = json.loads(stats_file.read_text())

# Generate HTML
html = '''<!DOCTYPE html>
<html lang=\"it\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>OB1 Scout - Dashboard</title>
    <meta name=\"theme-color\" content=\"#0f172a\">
    <link rel=\"manifest\" href=\"manifest.json\">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        header {
            text-align: center;
            padding: 30px 0;
        }
        .logo { font-size: 3em; }
        h1 { font-size: 1.8em; margin: 10px 0; }
        .badge {
            display: inline-block;
            background: #22c55e;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-number { font-size: 2em; font-weight: bold; color: #3b82f6; }
        .stat-label { color: #94a3b8; font-size: 0.9em; margin-top: 5px; }
        .card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }
        .card h2 { margin-bottom: 15px; font-size: 1.2em; }
        .opportunity {
            background: rgba(15, 23, 42, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #3b82f6;
        }
        .opportunity h3 { color: #fff; font-size: 1.1em; }
        .opportunity .meta { color: #94a3b8; font-size: 0.85em; margin-top: 5px; }
        .type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-top: 8px;
        }
        .type-svincolato { background: #22c55e; }
        .type-prestito { background: #3b82f6; }
        .type-rescissione { background: #f59e0b; }
        .type-scadenza { background: #ef4444; }
        footer {
            text-align: center;
            padding: 30px 0;
            color: #64748b;
            font-size: 0.85em;
        }
        @media (max-width: 500px) {
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class=\"container\">
        <header>
            <div class=\"logo\">‚öΩ</div>
            <h1>OB1 Scout Radar</h1>
            <span class=\"badge\">Serie C & D</span>
        </header>

        <div class=\"stats-grid\">
            <div class=\"stat-card\">
                <div class=\"stat-number\">''' + str(len(opportunities)) + '''</div>
                <div class=\"stat-label\">Opportunita Totali</div>
            </div>
            <div class=\"stat-card\">
                <div class=\"stat-number\">''' + str(stats.get('new_opportunities', 0)) + '''</div>
                <div class=\"stat-label\">Ultime 6 Ore</div>
            </div>
        </div>

        <div class=\"card\">
            <h2>üî• Ultime Opportunita</h2>
'''

# Add opportunities
for opp in opportunities[:10]:
    player = opp.get('player_name', 'N/D')
    club = opp.get('current_club', 'N/D')
    opp_type = opp.get('opportunity_type', 'mercato')
    summary = opp.get('summary', '')[:100]

    type_class = f'type-{opp_type.lower()}' if opp_type else ''

    html += f'''
            <div class=\"opportunity\">
                <h3>{player}</h3>
                <div class=\"meta\">üìç {club}</div>
                <div class=\"meta\">{summary}...</div>
                <span class=\"type-badge {type_class}\">{opp_type}</span>
            </div>
'''

html += '''
        </div>

        <footer>
            <p>Ultimo aggiornamento: ''' + datetime.now().strftime('%d/%m/%Y %H:%M') + '''</p>
            <p>OB1 Scout Radar - Intelligence Before Headlines</p>
        </footer>
    </div>

    <script>
        // PWA: Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>'''

# Save
docs_dir = Path('../docs')
docs_dir.mkdir(exist_ok=True)
(docs_dir / 'index.html').write_text(html)

# Create manifest for PWA
manifest = {
    'name': 'OB1 Scout Radar',
    'short_name': 'OB1 Scout',
    'start_url': '/',
    'display': 'standalone',
    'background_color': '#0f172a',
    'theme_color': '#0f172a',
    'icons': [
        {'src': 'icon-192.png', 'sizes': '192x192', 'type': 'image/png'},
        {'src': 'icon-512.png', 'sizes': '512x512', 'type': 'image/png'}
    ]
}
(docs_dir / 'manifest.json').write_text(json.dumps(manifest, indent=2))

# Create simple service worker
sw = '''
const CACHE_NAME = 'ob1-scout-v1';
self.addEventListener('install', e => self.skipWaiting());
self.addEventListener('fetch', e => {
    e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
});
'''
(docs_dir / 'sw.js').write_text(sw)

print('Dashboard generated!')
"

    - name: Commit and push dashboard
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "OB1 Scout Bot"
        git add docs/ data/ || true
        git diff --staged --quiet || git commit -m "ü§ñ Auto-update: $(date -u +'%Y-%m-%d %H:%M UTC')"
        git push || echo "Nothing to push"

    - name: Log completion
      run: |
        echo "‚úÖ Pipeline completed at $(date -u +'%Y-%m-%d %H:%M UTC')"
        echo "New opportunities: ${{ steps.ingest.outputs.new_count || 0 }}"
