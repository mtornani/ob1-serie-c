/**
 * OB1 Radar - Dashboard Application
 * Mobile-first PWA for Serie C/D scouting
 */

// =============================================================================
// State Management
// =============================================================================

const state = {
  opportunities: [],
  filteredOpportunities: [],
  savedOpportunities: [],
  currentFilter: 'all',
  currentRoleFilter: '',
  currentTypeFilter: '',
  currentPeriodFilter: '',
  searchQuery: '',
  isLoading: true,
  theme: 'dark'
};

// =============================================================================
// Production Mode - No Demo Data
// =============================================================================
// Data comes exclusively from data.json generated by the scraper

// =============================================================================
// DOM Elements
// =============================================================================

const elements = {
  opportunitiesGrid: document.getElementById('opportunitiesGrid'),
  emptyState: document.getElementById('emptyState'),
  searchInput: document.getElementById('searchInput'),
  filterChips: document.getElementById('filterChips'),
  roleFilter: document.getElementById('roleFilter'),
  typeFilter: document.getElementById('typeFilter'),
  periodFilter: document.getElementById('periodFilter'),
  totalCount: document.getElementById('totalCount'),
  hotCount: document.getElementById('hotCount'),
  warmCount: document.getElementById('warmCount'),
  recentCount: document.getElementById('recentCount'),
  lastUpdate: document.getElementById('lastUpdate'),
  themeToggle: document.getElementById('themeToggle'),
  refreshBtn: document.getElementById('refreshBtn'),
  modalOverlay: document.getElementById('modalOverlay'),
  modalTitle: document.getElementById('modalTitle'),
  modalContent: document.getElementById('modalContent'),
  modalClose: document.getElementById('modalClose'),
  pullIndicator: document.getElementById('pullIndicator'),
  toastContainer: document.getElementById('toastContainer')
};

// =============================================================================
// Initialization
// =============================================================================

document.addEventListener('DOMContentLoaded', () => {
  initTheme();
  initEventListeners();
  loadSavedOpportunities();
  loadData();

  // Initialize onboarding tutorial
  onboarding.init();
  addHelpButton();
});

function initTheme() {
  const savedTheme = localStorage.getItem('ob1-theme');
  if (savedTheme) {
    state.theme = savedTheme;
  } else {
    // Check system preference
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    state.theme = prefersDark ? 'dark' : 'light';
  }
  applyTheme();
}

function applyTheme() {
  if (state.theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
}

function toggleTheme() {
  state.theme = state.theme === 'dark' ? 'light' : 'dark';
  localStorage.setItem('ob1-theme', state.theme);
  applyTheme();
}

// =============================================================================
// Event Listeners
// =============================================================================

function initEventListeners() {
  // Theme toggle
  elements.themeToggle.addEventListener('click', toggleTheme);

  // Refresh button
  elements.refreshBtn.addEventListener('click', () => {
    loadData(true);
  });

  // Search input
  elements.searchInput.addEventListener('input', debounce((e) => {
    state.searchQuery = e.target.value.toLowerCase();
    filterOpportunities();
  }, 300));

  // Filter chips
  elements.filterChips.addEventListener('click', (e) => {
    const chip = e.target.closest('.filter-chip');
    if (chip) {
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      state.currentFilter = chip.dataset.filter;
      filterOpportunities();
    }
  });

  // Role filter
  elements.roleFilter.addEventListener('change', (e) => {
    state.currentRoleFilter = e.target.value;
    filterOpportunities();
  });

  // Type filter
  elements.typeFilter.addEventListener('change', (e) => {
    state.currentTypeFilter = e.target.value;
    filterOpportunities();
  });

  // Period filter
  elements.periodFilter.addEventListener('change', (e) => {
    state.currentPeriodFilter = e.target.value;
    filterOpportunities();
  });

  // Modal close
  elements.modalClose.addEventListener('click', closeModal);
  elements.modalOverlay.addEventListener('click', (e) => {
    if (e.target === elements.modalOverlay) {
      closeModal();
    }
  });

  // Bottom navigation
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      const view = item.dataset.view;
      handleNavigation(view);
    });
  });

  // Pull to refresh (mobile)
  initPullToRefresh();

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeModal();
    }
    if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
      e.preventDefault();
      elements.searchInput.focus();
    }
  });
}

// =============================================================================
// Data Loading
// =============================================================================

async function loadData(forceRefresh = false) {
  state.isLoading = true;
  showSkeletons();

  try {
    // Try to fetch from data.json first
    let data = null;

    try {
      const response = await fetch('data.json?t=' + Date.now());
      if (response.ok) {
        data = await response.json();
      }
    } catch (e) {
      console.log('No data.json found, using demo data');
    }

    // No demo data - show empty state if no real data
    if (!data || !data.opportunities) {
      data = { opportunities: [], last_update: new Date().toISOString() };
    }

    state.opportunities = data.opportunities;
    state.filteredOpportunities = [...state.opportunities];

    updateStats();
    filterOpportunities();
    updateLastUpdate(data.last_update);

    if (forceRefresh) {
      showToast('Dati aggiornati', 'success');
    }

  } catch (error) {
    console.error('Error loading data:', error);
    showToast('Errore nel caricamento dati', 'error');
  } finally {
    state.isLoading = false;
  }
}

// =============================================================================
// Filtering
// =============================================================================

function filterOpportunities() {
  let filtered = [...state.opportunities];

  // Classification filter
  if (state.currentFilter !== 'all') {
    filtered = filtered.filter(opp => opp.classification === state.currentFilter);
  }

  // Role filter
  if (state.currentRoleFilter) {
    filtered = filtered.filter(opp => opp.role === state.currentRoleFilter);
  }

  // Type filter
  if (state.currentTypeFilter) {
    filtered = filtered.filter(opp => opp.opportunity_type === state.currentTypeFilter);
  }

  // Period filter
  if (state.currentPeriodFilter && state.currentPeriodFilter !== 'all') {
    const days = parseInt(state.currentPeriodFilter);
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    
    filtered = filtered.filter(opp => {
      if (!opp.reported_date) return false;
      const oppDate = new Date(opp.reported_date);
      return oppDate >= cutoffDate;
    });
  }

  // Search query
  if (state.searchQuery) {
    filtered = filtered.filter(opp => {
      const searchable = [
        opp.player_name,
        opp.role_name,
        opp.opportunity_type,
        ...(opp.previous_clubs || [])
      ].join(' ').toLowerCase();
      return searchable.includes(state.searchQuery);
    });
  }

  // Sort by score (highest first)
  filtered.sort((a, b) => b.ob1_score - a.ob1_score);

  state.filteredOpportunities = filtered;
  renderOpportunities();
}

// =============================================================================
// Rendering
// =============================================================================

function renderOpportunities() {
  if (state.filteredOpportunities.length === 0) {
    elements.opportunitiesGrid.innerHTML = '';
    elements.emptyState.style.display = 'block';
    return;
  }

  elements.emptyState.style.display = 'none';
  elements.opportunitiesGrid.innerHTML = state.filteredOpportunities
    .map(opp => createOpportunityCard(opp))
    .join('');

   // Add click listeners
   document.querySelectorAll('.opportunity-card').forEach(card => {
     card.addEventListener('click', (e) => {
       if (!e.target.closest('.btn-card') && !e.target.closest('.toggle-breakdown')) {
         const oppId = card.dataset.id;
         const opp = state.opportunities.find(o => o.id === oppId);
         if (opp) showDetail(opp);
       }
     });
   });

   // Add score breakdown toggle listeners
   document.querySelectorAll('.toggle-breakdown').forEach(btn => {
     btn.addEventListener('click', (e) => {
       e.stopPropagation();
       const content = btn.nextElementSibling;
       content.classList.toggle('show');
     });
   });

  // Add button listeners
  document.querySelectorAll('.btn-save').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const oppId = btn.closest('.opportunity-card').dataset.id;
      toggleSave(oppId);
    });
  });
}

function createOpportunityCard(opp) {
   const isSaved = state.savedOpportunities.includes(opp.id);
   const scoreEmoji = opp.classification === 'hot' ? 'üî•' : opp.classification === 'warm' ? '‚ö°' : '‚ùÑÔ∏è';
   const breakdown = opp.ob1_breakdown || {};
   const estimatedLoanCost = opp.estimated_loan_cost || (opp.market_value ? Math.round(opp.market_value * 0.12) : 0);
   const currentClub = opp.current_club || 'Libero/Young';
   const oppType = opp.opportunity_type || 'Mercato';
   
   let oppTypeInfo = '';
   if (oppType.toLowerCase().includes('svincol')) {
     oppTypeInfo = 'üÜì Svincolato';
   } else if (oppType.toLowerCase().includes('rescis')) {
     oppTypeInfo = 'üìÑ Rescissione';
   } else if (oppType.toLowerCase().includes('prestit')) {
     oppTypeInfo = `üìà Prestito${estimatedLoanCost ? ` (${estimatedLoanCost}k‚Ç¨)` : ''}`;
   } else if (oppType.toLowerCase().includes('scaden')) {
     oppTypeInfo = 'üìÖ Scadenza';
   }
   
    let marketValueInfo = '';
    if (opp.market_value && opp.market_value > 0) {
      marketValueInfo = opp.market_value >= 1000000 
        ? `${(opp.market_value / 1000000).toFixed(1)}M‚Ç¨`
        : `${opp.market_value}k‚Ç¨`;
    }

   return `
     <article class="opportunity-card ${opp.classification} slide-up" data-id="${opp.id}">
       <div class="card-header">
         <div class="player-info">
           <span class="player-name">${opp.player_name}</span>
           <span class="player-role">${opp.role_name || opp.role}</span>
           <span class="player-club">${currentClub}</span>
         </div>
         <span class="score-badge ${opp.classification}">${scoreEmoji} ${opp.ob1_score}</span>
       </div>

       <div class="card-meta">
         <span class="meta-item">üéÇ ${opp.age} anni</span>
         <span class="meta-item">${marketValueInfo ? 'üí∞ ' + marketValueInfo : ''}</span>
         <span class="meta-item">${oppTypeInfo}</span>
       </div>

       <div class="score-breakdown-section">
         <button class="toggle-breakdown" aria-label="Vedi score breakdown">
           <span class="breakdown-icon">üìâ</span>
           <span class="breakdown-text">Score breakdown</span>
         </button>
         <div class="score-breakdown-content">
           ${createScoreBreakdown(breakdown)}
         </div>
       </div>

       <div class="card-status">
         <span class="type-badge ${oppType}">${oppType.toUpperCase()}</span>
         <span class="card-date">üìÖ ${formatDate(opp.reported_date)}</span>
       </div>

       <div class="card-recommendation">
         <span class="recommendation-icon">üí°</span>
         <span class="recommendation-text">${opp.recommendation || 'Giocatore.matcha con esigenze'}</span>
       </div>

       ${opp.previous_clubs && opp.previous_clubs.length > 0 ? `
         <div class="card-clubs">
           <span class="clubs-icon">üèÜ</span>
           <span class="clubs-text">Ex: ${opp.previous_clubs.slice(0, 3).join(', ')}</span>
         </div>
       ` : ''}

       <div class="card-actions">
         <button class="btn-card primary">üìä Dettagli</button>
         <button class="btn-card secondary btn-save" data-saved="${isSaved}">
           ${isSaved ? 'üíæ Salvato' : 'üìã Salva'}
         </button>
       </div>
     </article>
   `;
}

function createScoreBreakdown(breakdown) {
   const sections = [
     { key: 'position', label: 'Posizione', icon: 'üìç', weight: '25%' },
     { key: 'age', label: 'Et√†', icon: 'üéÇ', weight: '15%' },
     { key: 'style', label: 'Stile', icon: '‚öΩ', weight: '15%' },
     { key: 'availability', label: 'Disponibilit√†', icon: 'üìÖ', weight: '20%' },
     { key: 'budget', label: 'Budget', icon: 'üí∞', weight: '20%' },
     { key: 'level', label: 'Livello', icon: 'üìä', weight: '5%', optional: true },
   ];

   const maxScore = breakdown.position + breakdown.age + breakdown.style + 
                   breakdown.availability + breakdown.budget + 
                   (breakdown.level !== undefined ? breakdown.level : 0);

   return `
     <div class="breakdown-list">
       ${sections.map(section => {
         const score = breakdown[section.key];
         if (score === undefined && section.optional) return '';
         
         const formattedScore = score !== undefined ? score : 0;
         let colorClass = 'score-good';
         if (formattedScore < 50) colorClass = 'score-bad';
         else if (formattedScore < 75) colorClass = 'score-medium';

         return `
           <div class="breakdown-item ${colorClass}">
             <div class="breakdown-header">
               <span class="breakdown-icon">${section.icon}</span>
               <span class="breakdown-label">${section.label}</span>
               <span class="breakdown-weight">${section.weight}</span>
             </div>
             <div class="breakdown-content">
               <div class="progress-bar">
                 <div class="progress-fill ${colorClass}" style="width: ${formattedScore}%"></div>
               </div>
               <span class="breakdown-score">${formattedScore}</span>
             </div>
           </div>
         `;
       }).join('')}
     </div>
     <div class="breakdown-total">
       <span class="total-label">Totale:</span>
       <span class="total-score">${maxScore}%</span>
     </div>
   `;
}

function showSkeletons() {
  elements.opportunitiesGrid.innerHTML = `
    <div class="opportunity-card skeleton">
      <div class="skeleton-line title"></div>
      <div class="skeleton-line meta"></div>
      <div class="skeleton-line status"></div>
    </div>
    <div class="opportunity-card skeleton">
      <div class="skeleton-line title"></div>
      <div class="skeleton-line meta"></div>
      <div class="skeleton-line status"></div>
    </div>
    <div class="opportunity-card skeleton">
      <div class="skeleton-line title"></div>
      <div class="skeleton-line meta"></div>
      <div class="skeleton-line status"></div>
    </div>
  `;
}

// =============================================================================
// Stats
// =============================================================================

function updateStats() {
  const total = state.opportunities.length;
  const hot = state.opportunities.filter(o => o.classification === 'hot').length;
  const warm = state.opportunities.filter(o => o.classification === 'warm').length;
  const today = new Date().toISOString().split('T')[0];
  const recent = state.opportunities.filter(o => o.reported_date === today).length;

  animateNumber(elements.totalCount, total);
  animateNumber(elements.hotCount, hot);
  animateNumber(elements.warmCount, warm);
  animateNumber(elements.recentCount, recent);
}

function animateNumber(element, target) {
  const start = parseInt(element.textContent) || 0;
  const duration = 500;
  const startTime = performance.now();

  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const current = Math.floor(start + (target - start) * easeOutQuad(progress));
    element.textContent = current;

    if (progress < 1) {
      requestAnimationFrame(update);
    }
  }

  requestAnimationFrame(update);
}

function easeOutQuad(t) {
  return t * (2 - t);
}

function updateLastUpdate(timestamp) {
  if (timestamp) {
    const date = new Date(timestamp);
    elements.lastUpdate.textContent = `Ultimo aggiornamento: ${formatDateTime(date)}`;
  }
}

// =============================================================================
// Modal
// =============================================================================

function showDetail(opp) {
   elements.modalTitle.textContent = opp.player_name;
   
   const estimatedLoanCost = opp.estimated_loan_cost || (opp.market_value ? Math.round(opp.market_value * 0.12) : 0);
   const marketValue = opp.market_value;
   const currentClub = opp.current_club || 'Libero/Young';
   const oppType = opp.opportunity_type || 'Mercato';
   const breakdown = opp.ob1_breakdown || {};
   
   let oppTypeInfo = '';
   let oppTypeColor = '';
   if (oppType.toLowerCase().includes('svincol')) {
     oppTypeInfo = 'Svincolato';
     oppTypeColor = 'svincolato';
   } else if (oppType.toLowerCase().includes('rescis')) {
     oppTypeInfo = 'Rescissione';
     oppTypeColor = 'rescissione';
   } else if (oppType.toLowerCase().includes('prestit')) {
     oppTypeInfo = estimatedLoanCost 
       ? `Prestito (${estimatedLoanCost}k‚Ç¨)`
       : 'Prestito';
     oppTypeColor = 'prestito';
   } else if (oppType.toLowerCase().includes('scaden')) {
     oppTypeInfo = 'Scadenza';
     oppTypeColor = 'scadenza';
   }
   
    let marketValueInfo = '';
    if (marketValue && marketValue > 0) {
      marketValueInfo = marketValue >= 1000000 
        ? `${(marketValue / 1000000).toFixed(1)}M‚Ç¨`
        : `${marketValue}k‚Ç¨`;
    }
   
   const scoreEmoji = opp.classification === 'hot' ? 'üî•' : opp.classification === 'warm' ? '‚ö°' : '‚ùÑÔ∏è';

   elements.modalContent.innerHTML = `
     <div class="modal-score-section">
       <div class="score-header">
         <span class="score-badge ${opp.classification}" style="font-size: 1.5rem; padding: var(--space-sm) var(--space-lg);">
           ${scoreEmoji} ${opp.ob1_score} OB1 Score
         </span>
         <span class="type-badge ${oppTypeColor}">${oppTypeInfo}</span>
       </div>
       
       <div class="player-info-grid">
         <div class="player-info-item">
           <span class="info-label">Ruolo</span>
           <span class="info-value">${opp.role_name || opp.role}</span>
         </div>
         <div class="player-info-item">
           <span class="info-label">Et√†</span>
           <span class="info-value">${opp.age} anni</span>
         </div>
         <div class="player-info-item">
           <span class="info-label">Valore</span>
           <span class="info-value">${marketValueInfo || 'N/A'}</span>
         </div>
         <div class="player-info-item">
           <span class="info-label">Costo stima</span>
           <span class="info-value">${estimatedLoanCost ? estimatedLoanCost + 'k‚Ç¨' : 'N/A'}</span>
         </div>
         <div class="player-info-item">
           <span class="info-label">Club attuale</span>
           <span class="info-value">${currentClub}</span>
         </div>
       </div>
     </div>

     <div class="modal-section">
       <h4>üìä Score Breakdown</h4>
       <div class="score-breakdown-list">
         ${Object.entries(breakdown).map(([key, value]) => {
           const labels = {
             'position': 'Posizione (25%)',
             'age': 'Et√† (15%)',
             'style': 'Stile (15%)',
             'availability': 'Disponibilit√† (20%)',
             'budget': 'Budget (20%)',
             'level': 'Livello (5%)',
           };
           const label = labels[key] || key;
           
           let colorClass = 'score-good';
           if (value < 50) colorClass = 'score-bad';
           else if (value < 75) colorClass = 'score-medium';
           
           return `
             <div class="breakdown-item ${colorClass}">
               <div class="breakdown-header">
                 <span class="breakdown-label">${label}</span>
                 <span class="breakdown-score">${value}%</span>
               </div>
               <div class="progress-bar">
                 <div class="progress-fill ${colorClass}" style="width: ${value}%"></div>
               </div>
             </div>
           `;
         }).join('')}
       </div>
     </div>

     <div class="modal-section">
       <h4>üí° Raccomandazione</h4>
       <div class="recommendation-card">
         <span class="recommendation-icon">üí°</span>
         <p class="recommendation-text">${opp.recommendation || 'Analisi in corso...'}</p>
       </div>
     </div>

     ${opp.previous_clubs && opp.previous_clubs.length > 0 ? `
       <div class="modal-section">
         <h4>üèÜ Carriera</h4>
         <div class="career-path">
           ${opp.previous_clubs.join(' ‚Üí ')}
         </div>
       </div>
     ` : ''}

     <div class="modal-section">
       <h4>üìà Statistiche</h4>
       <div class="stats-grid">
         <div class="stat-item">
           <span class="stat-label">Presenze</span>
           <span class="stat-value">${opp.appearances || 'N/A'}</span>
         </div>
         <div class="stat-item">
           <span class="stat-label">Gol</span>
           <span class="stat-value">${opp.goals || 0}</span>
         </div>
         <div class="stat-item">
           <span class="stat-label">Assist</span>
           <span class="stat-value">${opp.assist || 0}</span>
         </div>
       </div>
     </div>

     <div class="modal-section">
       <h4>üîó Fonte</h4>
       <div class="source-info">
         <span class="source-name">${opp.source_name || 'OB1 Radar'}</span>
         <div class="source-links">
           ${opp.tm_url 
             ? `<a href="${opp.tm_url}" target="_blank" rel="noopener" class="btn-card primary" style="width: auto;">‚öΩ Profilo Transfermarkt</a>` 
             : opp.source_url 
               ? `<a href="${opp.source_url}" target="_blank" rel="noopener" class="btn-card primary" style="width: auto;">üîó Leggi articolo</a>` 
               : ''}
         </div>
       </div>
     </div>
   `;

   elements.modalOverlay.classList.add('active');
   document.body.style.overflow = 'hidden';
}

function closeModal() {
  elements.modalOverlay.classList.remove('active');
  document.body.style.overflow = '';
}

// =============================================================================
// Saved Opportunities
// =============================================================================

function loadSavedOpportunities() {
  const saved = localStorage.getItem('ob1-saved');
  state.savedOpportunities = saved ? JSON.parse(saved) : [];
}

function toggleSave(oppId) {
  const index = state.savedOpportunities.indexOf(oppId);
  if (index > -1) {
    state.savedOpportunities.splice(index, 1);
    showToast('Rimosso dai salvati', 'success');
  } else {
    state.savedOpportunities.push(oppId);
    showToast('Salvato!', 'success');
  }
  localStorage.setItem('ob1-saved', JSON.stringify(state.savedOpportunities));
  renderOpportunities();
}

// =============================================================================
// Navigation
// =============================================================================
// Stats View
// =============================================================================

function renderStatsView() {
  const opportunities = state.opportunities;
  
  // Calculate statistics
  const total = opportunities.length;
  const hot = opportunities.filter(o => o.ob1_score >= 80).length;
  const warm = opportunities.filter(o => o.ob1_score >= 60 && o.ob1_score < 80).length;
  const cold = opportunities.filter(o => o.ob1_score < 60).length;
  
  // Role distribution
  const roleCounts = {};
  opportunities.forEach(o => {
    const role = o.role_name || o.role || 'Sconosciuto';
    roleCounts[role] = (roleCounts[role] || 0) + 1;
  });
  
  // Type distribution
  const typeCounts = {};
  opportunities.forEach(o => {
    const type = o.opportunity_type || 'Altro';
    typeCounts[type] = (typeCounts[type] || 0) + 1;
  });
  
  // Recent opportunities (last 7 days)
  const oneWeekAgo = new Date();
  oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  const recentCount = opportunities.filter(o => {
    if (!o.reported_date) return false;
    return new Date(o.reported_date) >= oneWeekAgo;
  }).length;
  
  // Build stats HTML
  let statsHTML = `
    <div class="stats-view">
      <div class="stats-header">
        <h2>üìä Statistiche Mercato</h2>
        <p>Panoramica delle opportunit√† monitorate</p>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card total">
          <div class="stat-number">${total}</div>
          <div class="stat-label">Totale Giocatori</div>
        </div>
        <div class="stat-card hot">
          <div class="stat-number">${hot}</div>
          <div class="stat-label">üî• HOT (80+)</div>
        </div>
        <div class="stat-card warm">
          <div class="stat-number">${warm}</div>
          <div class="stat-label">‚ö° WARM (60-79)</div>
        </div>
        <div class="stat-card cold">
          <div class="stat-number">${cold}</div>
          <div class="stat-label">‚ùÑÔ∏è COLD (&lt;60)</div>
        </div>
      </div>
      
      <div class="stats-section">
        <h3>üìà Distribuzione per Ruolo</h3>
        <div class="stats-bars">
          ${Object.entries(roleCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5)
            .map(([role, count]) => {
              const percentage = ((count / total) * 100).toFixed(1);
              return `
                <div class="stat-bar-item">
                  <span class="bar-label">${role}</span>
                  <div class="bar-track">
                    <div class="bar-fill" style="width: ${percentage}%"></div>
                  </div>
                  <span class="bar-value">${count} (${percentage}%)</span>
                </div>
              `;
            }).join('')}
        </div>
      </div>
      
      <div class="stats-section">
        <h3>üíº Distribuzione per Tipo</h3>
        <div class="stats-bars">
          ${Object.entries(typeCounts)
            .sort(([,a], [,b]) => b - a)
            .map(([type, count]) => {
              const percentage = ((count / total) * 100).toFixed(1);
              return `
                <div class="stat-bar-item">
                  <span class="bar-label">${type}</span>
                  <div class="bar-track">
                    <div class="bar-fill" style="width: ${percentage}%"></div>
                  </div>
                  <span class="bar-value">${count} (${percentage}%)</span>
                </div>
              `;
            }).join('')}
        </div>
      </div>
      
      <div class="stats-summary">
        <div class="summary-item">
          <span class="summary-icon">üìÖ</span>
          <span class="summary-text">${recentCount} nuovi negli ultimi 7 giorni</span>
        </div>
      </div>
      
      <button class="btn-primary" onclick="handleNavigation('home')">
        ‚Üê Torna alle Opportunit√†
      </button>
    </div>
  `;
  
  elements.opportunitiesGrid.innerHTML = statsHTML;
  elements.emptyState.style.display = 'none';
}

function handleNavigation(view) {
  switch (view) {
    case 'home':
      state.currentFilter = 'all';
      document.querySelectorAll('.filter-chip').forEach(c => {
        c.classList.toggle('active', c.dataset.filter === 'all');
      });
      filterOpportunities();
      break;
    case 'search':
      elements.searchInput.focus();
      break;
    case 'saved':
      // Filter to show only saved
      state.filteredOpportunities = state.opportunities.filter(
        opp => state.savedOpportunities.includes(opp.id)
      );
      renderOpportunities();
      if (state.filteredOpportunities.length === 0) {
        showToast('Nessun giocatore salvato', 'info');
      }
      break;
    case 'stats':
      renderStatsView();
      break;
  }
}

// =============================================================================
// Pull to Refresh
// =============================================================================

function initPullToRefresh() {
  let touchStartY = 0;
  let isPulling = false;

  document.addEventListener('touchstart', (e) => {
    if (window.scrollY === 0) {
      touchStartY = e.touches[0].clientY;
    }
  }, { passive: true });

  document.addEventListener('touchmove', (e) => {
    if (window.scrollY === 0) {
      const touchY = e.touches[0].clientY;
      const diff = touchY - touchStartY;

      if (diff > 80 && !isPulling) {
        isPulling = true;
        elements.pullIndicator.classList.add('active');
      }
    }
  }, { passive: true });

  document.addEventListener('touchend', () => {
    if (isPulling) {
      isPulling = false;
      loadData(true);
      setTimeout(() => {
        elements.pullIndicator.classList.remove('active');
      }, 1000);
    }
  });
}

// =============================================================================
// Toast Notifications
// =============================================================================

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;

  elements.toastContainer.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(20px)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// =============================================================================
// Utilities
// =============================================================================

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString('it-IT', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
}

function formatDateTime(date) {
  return date.toLocaleDateString('it-IT', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// =============================================================================
// Onboarding Tutorial
// =============================================================================

const onboarding = {
  overlay: null,
  currentStep: 1,
  totalSteps: 5,

  init() {
    this.overlay = document.getElementById('onboardingOverlay');
    if (!this.overlay) return;

    // Check if user has seen the tutorial
    const hasSeenTutorial = localStorage.getItem('ob1-tutorial-completed');

    if (!hasSeenTutorial) {
      this.show();
    }

    this.bindEvents();
  },

  bindEvents() {
    // Skip button
    const skipBtn = document.getElementById('skipTutorial');
    if (skipBtn) {
      skipBtn.addEventListener('click', () => this.complete());
    }

    // Next button
    const nextBtn = document.getElementById('nextStep');
    if (nextBtn) {
      nextBtn.addEventListener('click', () => this.nextStep());
    }

    // Prev button
    const prevBtn = document.getElementById('prevStep');
    if (prevBtn) {
      prevBtn.addEventListener('click', () => this.prevStep());
    }

    // Finish button
    const finishBtn = document.getElementById('finishTutorial');
    if (finishBtn) {
      finishBtn.addEventListener('click', () => this.complete());
    }

    // Progress dots (click to navigate)
    document.querySelectorAll('.progress-dot').forEach(dot => {
      dot.addEventListener('click', () => {
        const step = parseInt(dot.dataset.step);
        if (step) this.goToStep(step);
      });
    });

    // Close on ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && this.overlay.classList.contains('active')) {
        this.complete();
      }
    });
  },

  show() {
    if (this.overlay) {
      this.overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      this.goToStep(1);
    }
  },

  hide() {
    if (this.overlay) {
      this.overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  },

  goToStep(step) {
    if (step < 1 || step > this.totalSteps) return;

    this.currentStep = step;

    // Update step visibility
    document.querySelectorAll('.onboarding-step').forEach(s => {
      s.classList.remove('active');
    });
    const currentStepEl = document.querySelector(`.onboarding-step[data-step="${step}"]`);
    if (currentStepEl) {
      currentStepEl.classList.add('active');
    }

    // Update progress dots
    document.querySelectorAll('.progress-dot').forEach(dot => {
      const dotStep = parseInt(dot.dataset.step);
      dot.classList.toggle('active', dotStep === step);
      dot.classList.toggle('completed', dotStep < step);
    });

    // Update navigation buttons
    const prevBtn = document.getElementById('prevStep');
    const nextBtn = document.getElementById('nextStep');
    const finishBtn = document.getElementById('finishTutorial');

    if (prevBtn) {
      prevBtn.style.display = step > 1 ? 'inline-flex' : 'none';
    }

    if (nextBtn && finishBtn) {
      if (step === this.totalSteps) {
        nextBtn.style.display = 'none';
        finishBtn.style.display = 'inline-flex';
      } else {
        nextBtn.style.display = 'inline-flex';
        finishBtn.style.display = 'none';
      }
    }
  },

  nextStep() {
    if (this.currentStep < this.totalSteps) {
      this.goToStep(this.currentStep + 1);
    }
  },

  prevStep() {
    if (this.currentStep > 1) {
      this.goToStep(this.currentStep - 1);
    }
  },

  complete() {
    localStorage.setItem('ob1-tutorial-completed', 'true');
    this.hide();
    showToast('Benvenuto in OB1 Radar! üéØ', 'success');
  },

  // Method to reset and show tutorial again (for help button)
  reset() {
    localStorage.removeItem('ob1-tutorial-completed');
    this.show();
  }
};

// Add help button to reopen tutorial
function addHelpButton() {
  const headerActions = document.querySelector('.header-actions');
  if (headerActions) {
    const helpBtn = document.createElement('button');
    helpBtn.className = 'btn-icon';
    helpBtn.id = 'helpBtn';
    helpBtn.setAttribute('aria-label', 'Aiuto');
    helpBtn.innerHTML = '‚ùì';
    helpBtn.addEventListener('click', () => onboarding.reset());
    headerActions.insertBefore(helpBtn, headerActions.firstChild);
  }
}

// =============================================================================
// Service Worker Registration
// =============================================================================

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('SW registered:', registration);
      })
      .catch(error => {
        console.log('SW registration failed:', error);
      });
  });
}
